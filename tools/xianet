#!/bin/bash
#
# Copyright 2012 Carnegie Mellon University
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# set this just in case user doesn't have it in their environment
# can be removed once libraries are installed in correct paths
LD_LIBRARY_PATH=.

NAME=`basename $0`
VERBOSE=0
CLICK_ONLY=0
ROUTER=0
HOST=0
DUAL_STACK=0
LOCAL_CHAIN_TOPOLOGY=0
NAMESERVER=0
IP_OVERRIDE_ADDR="None"
INTERFACE_FILTER="None"
HOST_INTERFACE="None"
RUN_VISUALIZER_CLIENT=0
RUN_VISUALIZER_SERVER=0
VISUALIZER_SERVER="localhost"

DAEMONS=""
ROUTER_DAEMONS="xroute xhcp_server"
HOST_DAEMONS="xhcp_client"
NAMESERVER_DAEMONS="xnameservice"
DUAL_STACK_HOST_EXTRA_DAEMONS="xroute_r0 xhcp_server_r0"
CHAIN_TOPOLOGY_DAEMONS="xroute_r0 xroute_r1 xhcp_server_r0 xhcp_server_r1 xhcp_client_h0 xhcp_client_h1 xnameservice"
VISUALIZER_CLIENT_DAEMONS="xstats"
VISUALIZER_SERVER_DAEMONS="statsserver"

# hacky way of finding the root of the XIA source tree
# assumes this script is in a directory off the parent of the XIA tree
# and that the daemons it starts are rooted off of the same location
#  so XIADIR would be /xia-core assuming the script were /xia-core/tools/xianet
XIADIR=$(dirname $(dirname $(cd ${0%/*} && echo $PWD/${0##*/})))

# click parameters
CLICKPATH=$XIADIR/click-2.0
CONFPATH=$CLICKPATH/conf
CLICK=$CLICKPATH/userlevel/click
SCRIPT=xia_chain_topology_socket_reliable_test.click
SCRIPT_SET=0


is_running()
{
	RUNNING=`ps a | grep "/$1" | grep -v grep`
	[ "$RUNNING" != "" ]
}

check_daemons()
{
	printf "XIA Demo Service Status\n"
	for svc in "click" $DAEMONS
	do
		status="stopped"
		is_running $svc
		[ $? -eq 0 ] && status="running"
		printf "%-16s: %s\n" $svc $status
	done
}

check_root()
{
	if [[ `whoami` != "root" ]]; then
		printf "\n ERROR: $NAME must be run as root\n\n"
		exit 1
	fi
}

stop_daemons()
{
	check_root

	printf "Stopping xia network processes\n"
	for svc in $DAEMONS "click"
	do
		printf "stopping: %s\n" $svc
		killall -9 $svc &> /dev/null
	done
}

start_daemons()
{
	printf "Starting XIA network processes\n"

	is_running "click"
	if [ $? -eq 0 ]; then
		printf "Click is already running, aborting...\n"
		exit 1
	fi

	check_root


	# 1) GENERATE A CLICK SCRIPT, IF NECESSARY
	FLAGS=""
	if [ $ROUTER -eq 1 ]; then
		FLAGS=$FLAGS" -r"
	fi
	if [ $HOST -eq 1 ]; then    
		FLAGS=$FLAGS" -t"
	fi
	if [ $DUAL_STACK -eq 1 ]; then
		FLAGS=$FLAGS" -4"
	fi
	if [ $IP_OVERRIDE_ADDR != "None" ]; then
		FLAGS=$FLAGS" -m "$IP_OVERRIDE_ADDR
	fi
	if [ $NAMESERVER -eq 1 ]; then
		FLAGS=$FLAGS" -n"
	fi
	if [ $INTERFACE_FILTER != "None" ]; then
		FLAGS=$FLAGS" -f "$INTERFACE_FILTER
	fi
	if [ $HOST_INTERFACE != "None" ]; then
		FLAGS=$FLAGS" -I "$HOST_INTERFACE
	fi
	cd $XIADIR/tools/click_templates
	python xconfig.py $FLAGS  # TODO: we maybe be calling this unnecessarily, but that's OK


	# 2) START CLICK
	if [ ! -f $CONFPATH/$SCRIPT ]; then
		SNAME=`basename $SCRIPT .click`
		printf "\nERROR: unable to locate click conf file: $SNAME\n\n"
		exit 1
	fi

	exec 3>&1  # save stdout handle
	if [ $VERBOSE -eq 0 ]; then
		exec &> /dev/null
	fi

	$CLICK -R $CONFPATH/$SCRIPT &
	if [ $CLICK_ONLY -eq 1 ]; then
		exit
	fi
	sleep 2


	is_running "click"
	if [ $? -ne 0 ]; then
		# put stdout handle back in case we were in silent mode
		exec 1>&3
		printf "Click is not running, aborting...\n"
		exit 1
	fi

	if [ $VERBOSE -eq 1 ]; then
		exec &> /dev/null
	fi


	# 3) START DAEMONS
	if [ $ROUTER -eq 1 ]; then
		cd $XIADIR/daemons/xroute
		./xroute & 
		sleep 2
		
		cd $XIADIR/daemons/xhcp
		./xhcp_server &
		sleep 1 
	fi
	if [ $HOST -eq 1 ]; then    

		if [ $DUAL_STACK -eq 1 ]; then
			cd $XIADIR/daemons/xroute
			./xroute_r0 & 
			sleep 2
			
			cd $XIADIR/daemons/xhcp
			./xhcp_server_r0 &
			sleep 1 
		fi
		
		cd $XIADIR/daemons/xhcp
		./xhcp_client www_h.$(hostname -s).com.xia  &  # TODO: test this
		sleep 2 
	fi
	if [ $NAMESERVER -eq 1 -a $HOST -eq 1 ]; then
		cd $XIADIR/daemons/nameserver
		./xnameservice &
	fi
	if [ $LOCAL_CHAIN_TOPOLOGY -eq 1 ]; then
		cd $XIADIR/daemons/xroute
		./xroute_r1 &
		./xroute_r0 & 
		sleep 2
		
		cd $XIADIR/daemons/xhcp
		./xhcp_server_r1 &
		./xhcp_server_r0 &
		sleep 1 
			
		./xhcp_client_h1 www_h.host1.com.xia &
		./xhcp_client_h0 www_h.host0.com.xia  &
		sleep 2 
			
		cd $XIADIR/daemons/nameserver
		./xnameservice &
	fi
	if [ $RUN_VISUALIZER_SERVER -eq 1 ]; then
		cd $XIADIR/daemons/visualizer
		./statsserver &
		sleep 1
	fi
	if [ $RUN_VISUALIZER_CLIENT -eq 1 ]; then
		FLAGS="-s $VISUALIZER_SERVER"
		if [ $VERBOSE -eq 2 ]; then
			FLAGS=$FLAGS" -v"
		fi
		cd $XIADIR/daemons/visualizer
		./xstats $FLAGS &
		sleep 1
	fi
}

help ()
{
	cat << EOH

Start or stop the XIA network services.

usage: $NAME [-cqvV4rtnZ] [-m <ip-addr>] [-f <filter_str>] [-I <interface>] [-s <script>] [-z <statserver>] [start|stop|restart|check]
where:
  -c only start click
  -s run click using the specified script
     (should be located in the $CONFPATH directory)
  -q run silently (default)
  -v prints click debug messages to stdout
  -V prints all daemon debug messages to stdout
  -4 generate and use a dual stack click script
  -r generate and use a generic router click script (like on GENI)
  -t generate and use a generic host click script (like on GENI)
  -m manually set the node's 4ID IP address
  -n if generating a click script, this node will be the name server
  -f if generating a click script don't use interfaces matching these filter strings (comma-separated)
  -I if generating a click script, use this interface (i.e., pick which interface a host uses)
  -z start the visualizer client daemon, using the supplied address for the statserver
  -Z make this the visualizer server (runs statserver and xstats)

  start   - starts the xia network processes if not already running
  stop    - stops the xia processes
  restart - stops then starts the xia processes
  check   - print service status

EOH
	exit 0
}

while getopts "cs:qvV4nrthm:f:I:z:Z" opt; do
	case $opt in
		c)
			CLICK_ONLY=1
			;;
		s)
			SCRIPT=$OPTARG
			SCRIPT_SET=1
			;;
		q)
			VERBOSE=0
			;;
		V)
			VERBOSE=2
			;;
		v)
			VERBOSE=1
			;;
		4)
			DUAL_STACK=1
			;;
		r)
			ROUTER=1
			;;
		t)
			HOST=1
			;;
		f)
			INTERFACE_FILTER=$OPTARG
			;;
		I)
			HOST_INTERFACE=$OPTARG
			;;
		m)
			IP_OVERRIDE_ADDR=$OPTARG
			;;
		n)
			NAMESERVER=1
			DAEMONS=$DAEMONS" "$NAMESERVER_DAEMONS
			;;
		z)
			RUN_VISUALIZER_CLIENT=1
			DAEMONS=$DAEMONS" "$VISUALIZER_CLIENT_DAEMONS
			VISUALIZER_SERVER=$OPTARG
			;;
		Z)
			RUN_VISUALIZER_CLIENT=1
			RUN_VISUALIZER_SERVER=1
			DAEMONS=$DAEMONS" "$VISUALIZER_CLIENT_DAEMONS
			DAEMONS=$DAEMONS" "$VISUALIZER_SERVER_DAEMONS
			;;
		h)
			help
			;;
		\?)
			printf "\nInvalid option: -$OPTARG\n" >&2
			help
			;;
	esac
done

if [ $SCRIPT_SET -eq 0 ]; then
	if [ $HOST -eq 1 ]; then
		CONFPATH=$XIADIR/tools/click_templates
		DAEMONS=$DAEMONS" "$HOST_DAEMONS
		if [ $DUAL_STACK -eq 0 ]; then
			SCRIPT=host.click
		else
			SCRIPT=dual_stack_host.click
			DAEMONS=$DAEMONS" "$DUAL_STACK_HOST_EXTRA_DAEMONS
		fi
	elif [ $ROUTER -eq 1 ]; then
		CONFPATH=$XIADIR/tools/click_templates
		DAEMONS=$DAEMONS" "$ROUTER_DAEMONS
		if [ $DUAL_STACK -eq 0 ]; then
			SCRIPT=router.click
		else
			SCRIPT=dual_stack_router.click
		fi
	else
		SCRIPT=xia_chain_topology_socket_reliable_test.click
	fi
fi

# By default, use CHAIN_TOPOLOGY_DAEMONS if others were not specified
if [ "$DAEMONS" == "" ]; then
	DAEMONS=$CHAIN_TOPOLOGY_DAEMONS
	LOCAL_CHAIN_TOPOLOGY=1
fi

echo "SCRIPT: $SCRIPT"
echo "DAEMONS: $DAEMONS"

shift $((OPTIND-1))

case $1 in
	start)
		start_daemons
		[ $VERBOSE == 0 ] && exec 1>&3
		check_daemons
		;;
	stop)
		stop_daemons
		;;
	restart|reload)
		stop_daemons
		sleep 1
		start_daemons
		[ $VERBOSE == 0 ] && exec 1>&3
		check_daemons
		;;
	check)
		check_daemons
		;;
	*)
		printf "\nInvalid command\n" >&2
		help
		;;
esac

