#!/bin/bash
#
# parse dashclient and proxy logs
# - create a csv file for each video session containing statistics for each chunk
# - generate graphs for eaqch csv file generated

# assume data files are 2 directories deep - day-mo-yr/cached-percentage/*.log
for d in $(find . -mindepth 2 -type d); do
	echo "processing $d"

	# now walk through client capture files
	for infile in "$d"/dashclient-*.log; do
		fname=$(basename "$infile" .log)
		csv="$d/$fname.csv"
		client=$(echo "$csv" | sed -e 's/.*-//; s/\..*//')
		cached=$(basename "$d")

		./client-stats "$infile" "$d/proxy.log" > "$csv"

		# make a data file for each video
		# FIXME: this doesn't help when a video is in the logs more than once
		for video in dash1 dash5 bunny elephant; do
			vfile="$d/$video-$client.dat"

			if [ -s "$vfile" ]; then
				# and plot the file

				# convert to make life easier in gnuplot
				grep "$video" "$csv"  | tr "," " " >> "$vfile"

				echo "  plotting client:$client video:$video cache amount:$cached %"
				./cdn-plot "$vfile" "$video" "$client" "$cached"
			fi
			#rm "$vfile"
		done
		rm "$csv"
	done
done
