#!/usr/bin/python

import sys
import os
import re

def help():
	print '\nusage: make_sockconf click_conf_file dest_file'
	print 'creates xsockconf.ini in the current directory based on the'
	print 'specified template file\n'
	sys.exit(-1)


if len(sys.argv) != 3:
	help()

lines = ''
try:
	with open(sys.argv[1]) as conf_file:
		for line in conf_file:
			# get rid of comments and whitespace
			line = line.partition('//')[0]
			line = line.strip()
			if len(line) == 0:
				continue
			lines += line
except:
	help()

try:
	sockconf = open(sys.argv[2], 'w')
except:
	print 'unable to open %s for writing' % sys.argv[2]

sockconf.write('# Generated from %s\n\n' % os.path.basename(sys.argv[1]))
sockconf.write('[default]\nclick_port=1500\n\n')

# look for elements of type XIAEndHost, XiaRouter[n]Port, and XIADualRouter[n]Port
test = re.compile('XIAEndHost|XIARouter\d+Port|XIADualRouter\d+Port')

lines = lines.split(';')
for line in lines:

	# find lines with an element definition
	element = re.search(test, line)
	if element == None:
		continue

	# which field is port defined in
	if element.group() == 'XIAEndHost':
		field = 2
	else:
		field = 4

	name, fields = line.split('::')
	fields = fields.split(',')
	name = name.strip()
	sockconf.write('[%s]\nclick_port=%s\n\n' % (name.strip(), fields[field].strip()))

sockconf.close

