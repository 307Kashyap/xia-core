#!/usr/bin/env python
#
# Copyright 2013 Carnegie Mellon University
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import re
import sys
import argparse
import clicksock
import xiapyutils

APP="xtrace"
APP_VERSION="1.0"

CMD="%s/xlc%s/print_out.verbosity"

levels = ["nothing", "nothing", "data packets only", "all traffic"]
r = re.compile("FromDevice\((.+?)\)[ \t]+->[ \t]+\[(.+?)\]")

def get_interfaces(click):
	interfaces = {}

	conf = click.readData("config").split("\n")
	for line in conf:
		m = r.match(line)
		if m != None:
			interfaces[m.group(1)] = m.group(2)
	return interfaces


def find_port(click, iface):


	conf = click.readData("config").split("\n")
	for line in conf:
		m = r.match(line)
		if m != None and m.group(1) == iface:
			return m.group(2)
	return -1

def print_status(click, iface):
	port = find_port(click, iface)
	if port != -1:
		cmd = CMD % (hostname, port)
		v = int(click.readData(cmd))
		print "tracing %s on %s" % (levels[v], iface)

#
# let's do this thing!
#
parser = argparse.ArgumentParser()
parser.add_argument("iface", nargs='?', help="ethernet interface to manage tracing on")
parser.add_argument("--version", action='store_true', help='display version number')
parser.add_argument("-v", "--verbose", action="store_true", help='trace data packets')
parser.add_argument("-V", "--noisy", action="store_true", help='trace data and management packets (very noisy!)')
parser.add_argument("-q", "--quiet", action='store_true', help='disable packet traces')
args = parser.parse_args()

if args.version:
	print "%s %s" % (APP, APP_VERSION)
	sys.exit(0)

hostname = xiapyutils.getxiaclickhostname()

with clicksock.clicksock() as click:

	if args.iface != None:
		port = find_port(click, args.iface)
		if port == -1:
			print "no XIA port associated with interface %s" % args.iface
			sys.exit(1)

		cmd = CMD % (hostname, port)

		if args.verbose:
			click.writeData(cmd + " 2")
		elif args.noisy:
			click.writeData(cmd + " 3")
		elif args.quiet:
			click.writeData(cmd + " 0")
			verbosity = 0
		print_status(click, args.iface)

	elif args.verbose != True and args.noisy != True and args.quiet != True:
		interfaces = get_interfaces(click)
		for iface, port in interfaces.iteritems():
			print_status(click, iface)

	else:
		print "You must specify an interface card"
		sys.exit(1)

