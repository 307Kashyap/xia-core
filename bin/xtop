#!/bin/bash
#
# run top with xia related processes only
#

[ "$1" == "-v" ] || [ "$1" == "--version" ] && echo "xtop 1.0" && exit 0

if [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
	cat << EOH
xtop [name] [name] ...

run top showing only the XIA related processes

options:
  name          additional processes to monitor
  -h, --help    display this help
  -v, --version display the version number
  -d, --debug   show info for gdb and valgrind as well
EOH
	exit 0
fi


# because they are python scripts, these daemons needs to be treated differently
x=$(pgrep -f 'xnetj|broker|pinger' | tr '\n' ',')

# get the rest of the click processes (replace \n in pgrep output with ,)
x="$x$(pgrep 'click|xrouted|xcontrold|xhostd|xcache|xname|xiaproxy|load_video|xmanifestd|statsserver|xstats' | tr '\n ' ',')"

# show debug processes in case we are running a daemon with them
if [ "$1" == "-d" ] || [ "$1" == "--debug" ]; then
	x=$x$(pgrep -f 'valgrind|gdb' | tr '\n' ',')

	# strip the debug switch
	shift
fi

# add anything from the command line
for p in $@; do
	# pgrep may return multiple processes, so add commas if needed
	x="$x$(pgrep $p | tr '\n ' ',')"
done

#strip the trailing ,
x=${x%?}

[ "$x" ] && top -c -p "$x"
