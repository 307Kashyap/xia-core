#!/bin/sh
rtl="/Applications/omniTools-2.6/readyToLogin.app/Contents/MacOS/readyToLogin"
omni="/Applications/omniTools-2.6/omni.app/Contents/MacOS/omni --error "

if [ $# != 2 ]; then
	echo usage: xbuild slivername aggregate
	echo use: omni nicknames to find valid aggregate names
	exit
fi

read -p "WARNING: .ssh/config will be overwritten. Make a backup before running this command!"

T="$(date +%s)"

echo creating slice
$omni createslice $1

echo creating sliver
$omni createsliver -a $2 $1 xiatutorial.rspec

echo waiting for sliver to be ready
numready=0
while true; do
	numready=`$rtl -a $2 $1 | grep status:ready | wc | tr -s " " | cut -d " " -f 2`
	if [ $numready -eq 5 ]; then
		break
	elif [ $numready -gt 0 ]; then
		echo $numready node(s) are in the ready state
	else
		echo rechecking...
	fi
	sleep 15
done

T="$(($(date +%s)-T))"
printf "Imaging %s on $s took %02d:%02d\n" $1 $2 "$((T/60))" "$((T%60))"

$rtl -a $2 $1 -o
cp sshconfig.txt ~/.ssh/config
echo copied sshconfig.txt to ~/.ssh/config
